{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Music Generator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>
<body>
    <header class="app-header py-3">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="logo-text h3 mb-0">AI Music Generator</h1>
                <div>
                    <a href="#" class="btn btn-outline-primary me-2">Help</a>
                    <a href="#" class="btn btn-outline-primary">My Music</a>
                </div>
            </div>
        </div>
    </header>

    <main class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <!-- Alerts Container -->
                <div id="alertsContainer" class="mb-4"></div>
                
                <div class="primary-card">
                    <div class="card-header">
                        <ul class="nav nav-tabs card-header-tabs" id="generationTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="video-tab" data-bs-toggle="tab" data-bs-target="#video-pane" type="button" role="tab" aria-controls="video-pane" aria-selected="true">
                                    <i class="bi bi-camera-video me-2"></i>Video To Music
                                </button>
                            </li>
                            
                        </ul>
                    </div>
                    
                    <div class="tab-content" id="generationTabsContent">
                        <div class="tab-pane fade show active" id="video-pane" role="tabpanel" aria-labelledby="video-tab" tabindex="0">
                            
                            <form method="post" id="generationForm" enctype="multipart/form-data">
                                {% csrf_token %}
                                <input type="hidden" id="selectedGenre" name="genre" value="electronic">
                                
                                <h2 class="h4 mb-4">Generate Music from Video</h2>
                                
                                <div class="mb-4">
                                    <label class="form-label">Upload Video</label>
                                    <div class="video-upload-zone" id="videoUploadZone">
                                        <input type="file" id="videoFile" name="videoFile" accept="video/*" class="d-none">
                                        <div class="upload-icon">
                                            <i class="bi bi-cloud-arrow-up"></i>
                                        </div>
                                        <h3 class="h5">Drag & Drop your video here</h3>
                                        <p class="text-muted">or click to browse</p>
                                        <p class="small text-muted">Supported formats: MP4, MOV, AVI (Max 100MB)</p>
                                    </div>
                                    
                                    <!-- Video Preview Container -->
                                    <div class="video-preview-container" id="videoPreviewContainer">
                                        <video class="video-preview" id="videoPreview" controls></video>
                                    </div>
                                    
                                    <!-- Video File Name -->
                                    <div class="d-flex justify-content-between align-items-center mt-2">
                                        <span id="videoFileName" class="small text-muted"></span>
                                        <button type="button" id="removeVideoBtn" class="btn btn-sm btn-outline-danger" style="display: none;">
                                            <i class="bi bi-trash me-1"></i>Remove
                                        </button>
                                    </div>
                                    
                                    <!-- Upload Progress -->
                                    <div class="progress mt-3" id="uploadProgress" style="display: none;">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated" id="uploadProgressBar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%"></div>
                                    </div>
                                </div>
                                
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <label class="form-label">Music Genre</label>
                                        <div class="row g-3">
                                            <div class="col-6">
                                                <div class="genre-card" data-genre="electronic">
                                                    <div class="card-body text-center">
                                                        <div class="genre-icon">
                                                            <i class="bi bi-speaker"></i>
                                                        </div>
                                                        <h3 class="h6 mb-0">Electronic</h3>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="genre-card" data-genre="pop">
                                                    <div class="card-body text-center">
                                                        <div class="genre-icon">
                                                            <i class="bi bi-music-note-beamed"></i>
                                                        </div>
                                                        <h3 class="h6 mb-0">Pop</h3>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="genre-card" data-genre="ambient">
                                                    <div class="card-body text-center">
                                                        <div class="genre-icon">
                                                            <i class="bi bi-water"></i>
                                                        </div>
                                                        <h3 class="h6 mb-0">Ambient</h3>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="genre-card" data-genre="cinematic">
                                                    <div class="card-body text-center">
                                                        <div class="genre-icon">
                                                            <i class="bi bi-film"></i>
                                                        </div>
                                                        <h3 class="h6 mb-0">Cinematic</h3>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <div class="mb-4">
                                            <label class="form-label">AI Model Selection</label>
                                            <div class="d-grid gap-3">
                                                <button type="button" id="gptModelBtn" class="btn btn-outline-primary py-3">
                                                    <i class="bi bi-stars me-2"></i>Generate with GPT
                                                </button>
                                                
                                                <button type="button" id="localModelBtn" class="btn btn-outline-primary py-3">
                                                    <i class="bi bi-cpu me-2"></i>Generate with Local English Model
                                                </button>
                                            </div>
                                            <input type="hidden" name="model_type" id="modelTypeInput" value="">
                                            <div class="small text-muted mt-1">Select an AI model to generate your music</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="d-grid gap-2">
                                    <button type="submit" class="btn btn-primary btn-lg">
                                        <i class="bi bi-music-note me-2"></i>Generate Music
                                    </button>
                                </div>
                            </form>
                        </div>
                        
                        <div class="tab-pane fade" id="parameters-pane" role="tabpanel" aria-labelledby="parameters-tab" tabindex="0">
                            <h2 class="h4 mb-4">Custom Generation Parameters</h2>
                            
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="complexity" class="form-label">Complexity</label>
                                        <select class="form-select" id="complexity" name="complexity">
                                            <option value="simple">Simple</option>
                                            <option value="moderate" selected>Moderate</option>
                                            <option value="complex">Complex</option>
                                            <option value="very_complex">Very Complex</option>
                                        </select>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="mood" class="form-label">Mood</label>
                                        <select class="form-select" id="mood" name="mood">
                                            <option value="happy">Happy</option>
                                            <option value="sad">Sad</option>
                                            <option value="energetic" selected>Energetic</option>
                                            <option value="calm">Calm</option>
                                            <option value="dramatic">Dramatic</option>
                                            <option value="mysterious">Mysterious</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="instruments" class="form-label">Featured Instruments</label>
                                        <select class="form-select" id="instruments" name="instruments" multiple>
                                            <option value="piano">Piano</option>
                                            <option value="guitar">Guitar</option>
                                            <option value="strings">Strings</option>
                                            <option value="drums">Drums</option>
                                            <option value="synth" selected>Synthesizer</option>
                                            <option value="bass">Bass</option>
                                            <option value="brass">Brass</option>
                                        </select>
                                        <div class="small text-muted mt-1">Hold Ctrl/Cmd to select multiple</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="structure" class="form-label">Structure</label>
                                        <select class="form-select" id="structure" name="structure">
                                            <option value="intro_verse_chorus">Intro-Verse-Chorus</option>
                                            <option value="verse_chorus" selected>Verse-Chorus</option>
                                            <option value="ambient">Ambient Flow</option>
                                            <option value="loop">Seamless Loop</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="tab-pane fade" id="advanced-pane" role="tabpanel" aria-labelledby="advanced-tab" tabindex="0">
                            <h2 class="h4 mb-4">Advanced Options</h2>
                            
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="key" class="form-label">Musical Key</label>
                                        <select class="form-select" id="key" name="key">
                                            <option value="C">C Major</option>
                                            <option value="Cm">C Minor</option>
                                            <option value="D">D Major</option>
                                            <option value="Dm">D Minor</option>
                                            <option value="E">E Major</option>
                                            <option value="Em">E Minor</option>
                                            <option value="F">F Major</option>
                                            <option value="Fm">F Minor</option>
                                            <option value="G">G Major</option>
                                            <option value="Gm">G Minor</option>
                                            <option value="A">A Major</option>
                                            <option value="Am" selected>A Minor</option>
                                            <option value="B">B Major</option>
                                            <option value="Bm">B Minor</option>
                                        </select>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="time_signature" class="form-label">Time Signature</label>
                                        <select class="form-select" id="time_signature" name="time_signature">
                                            <option value="4/4" selected>4/4</option>
                                            <option value="3/4">3/4</option>
                                            <option value="6/8">6/8</option>
                                            <option value="5/4">5/4</option>
                                            <option value="7/8">7/8</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="prompt" class="form-label">Text Prompt (Optional)</label>
                                        <textarea class="form-control" id="prompt" name="prompt" rows="3" placeholder="Describe the music you want to generate..."></textarea>
                                        <div class="small text-muted mt-1">Use descriptive language to guide the generation</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="reference_url" class="form-label">Reference Track URL (Optional)</label>
                                        <input type="url" class="form-control" id="reference_url" name="reference_url" placeholder="https://example.com/music.mp3">
                                        <div class="small text-muted mt-1">URL to a reference track for style inspiration</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label d-block">Advanced Voice Settings</label>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" role="switch" id="advancedVocals" name="advancedVocals">
                                    <label class="form-check-label" for="advancedVocals">Enable advanced vocal processing</label>
                                </div>
                            </div>
                            
                            <div id="vocalSettings" class="mb-4 ps-4 border-start" style="display: none;">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="voice_type" class="form-label">Voice Type</label>
                                            <select class="form-select" id="voice_type" name="voice_type">
                                                <option value="female" selected>Female</option>
                                                <option value="male">Male</option>
                                                <option value="neutral">Gender Neutral</option>
                                                <option value="robotic">Robotic</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="lyrics_language" class="form-label">Lyrics Language</label>
                                            <select class="form-select" id="lyrics_language" name="lyrics_language">
                                                <option value="english" selected>English</option>
                                                <option value="spanish">Spanish</option>
                                                <option value="french">French</option>
                                                <option value="japanese">Japanese</option>
                                                <option value="korean">Korean</option>
                                                <option value="none">No Lyrics (Vocalizing)</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="lyrics_theme" class="form-label">Lyrics Theme</label>
                                    <input type="text" class="form-control" id="lyrics_theme" name="lyrics_theme" placeholder="Enter a theme for generated lyrics">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Loading Section (Initially Hidden) -->
                <div class="primary-card mt-4" id="loadingSection" style="display: none;">
                    <div class="card-body">
                        <div class="loading-container">
                            <div class="loading-spinner mb-3"></div>
                            <h3 class="h5 mb-2">Generating Your Music</h3>
                            <p class="text-muted">We're analyzing your video and creating a unique music composition...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Results Section (Initially Hidden) -->
                <div class="primary-card mt-4" id="resultsSection" style="display: none;">
                    <div class="card-header">
                        <h2 class="h4 mb-0">Your Generated Music</h2>
                    </div>
                    <div class="card-body">
                        <div class="audio-player-container">
                            <div class="d-flex align-items-center mb-3">
                                <button class="btn btn-primary rounded-circle me-3" id="playBtn" style="width: 50px; height: 50px;">
                                    <i class="bi bi-play-fill"></i>
                                </button>
                                <div class="flex-grow-1">
                                    <audio id="musicPlayer" class="audio-player" preload="metadata"></audio>
                                    <div id="waveform" class="waveform-container"></div>
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-end">
                                <button class="btn btn-outline-primary me-2" id="regenerateBtn">
                                    <i class="bi bi-arrow-repeat me-2"></i>Regenerate
                                </button>
                                <!--- <a  download class="btn btn-primary" id="downloadBBtn">
                                   <i class="bi bi-download me-2"></i>Download
                                </a> --->
                            </div>
                        </div>
                    </div>

                    <script>
                    // 播放音乐
                    document.getElementById('playBtn')?.addEventListener('click', function () {
                        // document.getElementById("musicPlayer").play()
                        showAlert('播放音乐');

                        const audioPlayer = document.getElementById('musicPlayer');
                        
                        // 切换播放/暂停
                        if (audioPlayer.paused) {
                            audioPlayer.play();
                            this.innerHTML = '<i class="bi bi-pause-fill"></i>'; // 改变按钮图标为暂停
                        } else {
                            audioPlayer.pause();
                            this.innerHTML = '<i class="bi bi-play-fill"></i>'; // 改变按钮图标为播放
                        }
                    });
                    </script>

                </div>
            </div>
        </div>
    </main>
    
    <footer class="py-4 mt-5 border-top" style="background: rgba(0, 0, 0, 0.3);">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h3 class="h5 logo-text mb-3">AI Music Generator</h3>
                    <p class="text-muted mb-0">Create unique music compositions powered by advanced AI technology</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <ul class="list-inline mb-0">
                        <li class="list-inline-item"><a href="#" class="text-decoration-none text-white-50">About</a></li>
                        <li class="list-inline-item"><a href="#" class="text-decoration-none text-white-50">Privacy</a></li>
                        <li class="list-inline-item"><a href="#" class="text-decoration-none text-white-50">Terms</a></li>
                        <li class="list-inline-item"><a href="#" class="text-decoration-none text-white-50">Contact</a></li>
                    </ul>
                    <p class="text-muted mt-2 mb-0">&copy; 2023 AI Music Generator. All rights reserved.</p>
                </div>
            </div>
        </div>
    </footer>

    
    <script>
        function showAlert(message, type = 'info') {
            const alertBox = document.createElement('div');
            alertBox.className = `alert alert-${type}`;
            alertBox.textContent = message;
            document.getElementById('alertsContainer')?.appendChild(alertBox);
            setTimeout(() => alertBox.remove(), 5000);
        }

        function updateMusicInfo(data) {
            if (!data || !data.generation_info) return;
            const info = data.generation_info;
            document.getElementById('resultGenre').textContent = info.genre || '-';
            document.getElementById('resultTempo').textContent = info.complexity === 'complex' ? '140 BPM' : '120 BPM';
            document.getElementById('resultLength').textContent = '60 seconds';
            document.getElementById('resultVocals').textContent = info.model || '-';
            document.getElementById('generationTime').textContent = info.generated_at || '-';
        }

        // 更新下载
        /* function updateDownload(data){
            // 设置下载按钮
            const downloadBtn = document.getElementById('downloadBBtn');
            downloadBtn.href = data.music_url;
            downloadBtn.download = data.music_url.split('/').pop();
            downloadBtn.style.display = 'inline-block';
        }*/

        // 拖拽上传功能
        function setupVideoUpload() {
            const uploadZone = document.getElementById('videoUploadZone');
            const fileInput = document.getElementById('videoFile');
            const videoPreviewContainer = document.getElementById('videoPreviewContainer');
            const videoPreview = document.getElementById('videoPreview');
            const uploadProgress = document.getElementById('uploadProgress');
            const videoFileNameEl = document.getElementById('videoFileName');
            const removeVideoBtn = document.getElementById('removeVideoBtn');

            if (!uploadZone || !fileInput) return;

            uploadZone.addEventListener('click', () => fileInput.click());

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadZone.addEventListener(eventName, e => {
                    e.preventDefault();
                    e.stopPropagation();
                });
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                uploadZone.addEventListener(eventName, () => uploadZone.classList.add('drag-over'));
            });

            ['dragleave', 'drop'].forEach(eventName => {
                uploadZone.addEventListener(eventName, () => uploadZone.classList.remove('drag-over'));
            });

            uploadZone.addEventListener('drop', (e) => {
                const files = e.dataTransfer.files;
                if (files.length) {
                    fileInput.files = files;
                    handleVideoFile(files[0]);
                }
            });

            fileInput.addEventListener('change', () => {
                if (fileInput.files.length) {
                    handleVideoFile(fileInput.files[0]);
                }
            });

            function handleVideoFile(file) {
                if (!file.type.match('video/*')) {
                    showAlert('请选择有效的视频文件', 'danger');
                    return;
                }

                if (videoFileNameEl) videoFileNameEl.textContent = file.name;

                const reader = new FileReader();
                reader.onload = function(e) {
                    videoPreview.src = e.target.result;
                    videoPreviewContainer.style.display = 'block';
                    removeVideoBtn.style.display = 'block';
                    uploadZone.style.display = 'none'; // 隐藏上传区
                };
                reader.readAsDataURL(file);
            }
        }

        setupVideoUpload();

        // 模型按钮点击逻辑
        document.getElementById('gptModelBtn')?.addEventListener('click', function () {
            document.getElementById('modelTypeInput').value = 'gpt';
            this.classList.remove('btn-outline-primary');
            this.classList.add('btn-primary');
            document.getElementById('localModelBtn').classList.remove('btn-primary');
            document.getElementById('localModelBtn').classList.add('btn-outline-primary');
        });

        document.getElementById('localModelBtn')?.addEventListener('click', function () {
            document.getElementById('modelTypeInput').value = 'local';
            this.classList.remove('btn-outline-primary');
            this.classList.add('btn-primary');
            document.getElementById('gptModelBtn').classList.remove('btn-primary');
            document.getElementById('gptModelBtn').classList.add('btn-outline-primary');
        });


        document.getElementById('generationForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const form = this;
            const modelType = document.getElementById('modelTypeInput').value;
            const videoFile = document.getElementById('videoFile').files[0];
            const loadingSection = document.getElementById('loadingSection');
            const resultsSection = document.getElementById('resultsSection');

            if (!modelType) {
                showAlert('请先选择一个AI模型', 'warning');
                return;
            }
            if (!videoFile) {
                showAlert('请上传一个视频文件', 'warning');
                return;
            }

            if (loadingSection) {
                loadingSection.style.display = 'block';
                loadingSection.scrollIntoView({ behavior: 'smooth' });
            }
            if (resultsSection) resultsSection.style.display = 'none';

            const formData = new FormData(form);

            const isGptSelected = document.getElementById('gptModelBtn').classList.contains('btn-primary');
            const isLocalSelected = document.getElementById('localModelBtn').classList.contains('btn-primary');

            let targetUrl = '';
            if (isGptSelected) {
                targetUrl = 'gpt-generate-music/';
            } else if (isLocalSelected) {
                targetUrl = 'local-model-generate-music/';
            } else {
                showAlert('请先选择一个AI模型', 'warning');
                return;
            }

            fetch(targetUrl, {
                method: 'POST',
                headers: { 'X-Requested-With': 'XMLHttpRequest' },
                body: formData
            })
            .then(response => {
                if (!response.ok) throw new Error('服务器错误');
                return response.json();
            })
            .then(data => {
                loadingSection.style.display = 'none';
                if (data.music_url) {
                    resultsSection.style.display = 'block';
                    resultsSection.scrollIntoView({ behavior: 'smooth' });
                    const audioPlayer = document.getElementById('musicPlayer');
                    audioPlayer.src = data.music_url;
                    if (window.wavesurfer) {
                        window.wavesurfer.load(audioPlayer.src);
                    }
                    // 更新
                    updateMusicInfo(data);
                    // updateDownload(data);

                    
                } else {
                    showAlert('生成失败：' + (data.error || '未返回音乐链接'), 'danger');
                }
            })
            .catch(err => {
                loadingSection.style.display = 'none';
                showAlert('音乐生成失败，请稍后重试', 'danger');
                console.error(err);
            });
        });

        document.getElementById('regenerateBtn')?.addEventListener('click', function () {
            document.getElementById('generationForm').dispatchEvent(new Event('submit'));
        });

    </script>
</body>
</html> 