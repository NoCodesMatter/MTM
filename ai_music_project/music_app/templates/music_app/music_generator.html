{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Music Generator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>
<body>
    <header class="app-header py-3">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <h1 style="text-align: center;"class="logo-text h3 mb-0">AI Music Generator</h1>
            </div>
        </div>
    </header>

    <main class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <!-- Alerts Container -->
                <div id="alertsContainer" class="mb-4"></div>
                
                <div class="primary-card">
                    <div class="card-header">
                        <ul class="nav nav-tabs card-header-tabs" id="generationTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="video-tab" data-bs-toggle="tab" data-bs-target="#video-pane" type="button" role="tab" aria-controls="video-pane" aria-selected="true">
                                    <i class="bi bi-camera-video me-2"></i>Video To Music
                                </button>
                            </li>
                            
                        </ul>
                    </div>
                    
                    <div class="tab-content" id="generationTabsContent">
                        <div class="tab-pane fade show active" id="video-pane" role="tabpanel" aria-labelledby="video-tab" tabindex="0">
                            
                            <form method="post" id="generationForm" enctype="multipart/form-data">
                                {% csrf_token %}
                                <input type="hidden" id="selectedGenre" name="genre" value="electronic">
                                
                                <h2 class="h4 mb-4">Generate Music from Video</h2>
                                
                                <div class="mb-4">
                                    <label class="form-label">Upload Video</label>
                                    <div class="video-upload-zone" id="videoUploadZone">
                                        <input type="file" id="videoFile" name="videoFile" accept="video/*" class="d-none">
                                        <div class="upload-icon">
                                            <i class="bi bi-cloud-arrow-up"></i>
                                        </div>
                                        <h3 class="h5">Drag & Drop your video here</h3>
                                        <p class="text-muted">or click to browse</p>
                                        <p class="small text-muted">Supported formats: MP4, MOV, AVI (Max 100MB)</p>
                                    </div>
                                    
                                    <!-- Video Preview Container -->
                                    <div class="video-preview-container" id="videoPreviewContainer">
                                        <video class="video-preview" id="videoPreview" controls></video>
                                    </div>
                                    
                                    <!-- Video File Name -->
                                    <div class="d-flex justify-content-between align-items-center mt-2">
                                        <span id="videoFileName" class="small text-muted"></span>
                                        <button type="button" id="removeVideoBtn" class="btn btn-sm btn-outline-danger" style="display: none;">
                                            <i class="bi bi-trash me-1"></i>Remove
                                        </button>
                                    </div>
                                    
                                    <!-- Upload Progress -->
                                    <div class="progress mt-3" id="uploadProgress" style="display: none;">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated" id="uploadProgressBar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%"></div>
                                    </div>
                                </div>
                                
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <label class="form-label">Music Genre</label>
                                        <div class="row g-3">
                                            <div class="col-6">
                                                <div class="genre-card selected" data-genre="electronic">
                                                    <div class="card-body text-center">
                                                        <div class="genre-icon">
                                                            <i class="bi bi-speaker"></i>
                                                        </div>
                                                        <h3 class="h6 mb-0">Electronic</h3>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="genre-card" data-genre="pop">
                                                    <div class="card-body text-center">
                                                        <div class="genre-icon">
                                                            <i class="bi bi-music-note-beamed"></i>
                                                        </div>
                                                        <h3 class="h6 mb-0">Pop</h3>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="genre-card" data-genre="ambient">
                                                    <div class="card-body text-center">
                                                        <div class="genre-icon">
                                                            <i class="bi bi-water"></i>
                                                        </div>
                                                        <h3 class="h6 mb-0">Ambient</h3>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="genre-card" data-genre="cinematic">
                                                    <div class="card-body text-center">
                                                        <div class="genre-icon">
                                                            <i class="bi bi-film"></i>
                                                        </div>
                                                        <h3 class="h6 mb-0">Cinematic</h3>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Video Denoise Option -->
                                        <div class="mt-4">
                                            <label class="form-label d-block">Video Processing</label>
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" role="switch" id="denoiseVideo" name="denoise" value="true">
                                                <label class="form-check-label" for="denoiseVideo">Denoise video before analysis</label>
                                            </div>
                                            <div class="small text-muted mt-1">Reduces noise in the video to improve emotion detection</div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <div class="mb-4">
                                            <label class="form-label">AI Model Selection</label>
                                            <div class="d-grid gap-3">
                                                <button type="button" id="gptModelBtn" class="btn btn-outline-primary py-3">
                                                    <i class="bi bi-stars me-2"></i>Generate with GPT
                                                </button>
                                                
                                                <button type="button" id="localModelBtn" class="btn btn-outline-primary py-3">
                                                    <i class="bi bi-cpu me-2"></i>Generate with Local English Model
                                                </button>
                                            </div>
                                            <input type="hidden" name="model_type" id="modelTypeInput" value="">
                                            <div class="small text-muted mt-1">Select an AI model to generate your music</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="d-grid gap-2">
                                    <button type="submit" class="btn btn-primary btn-lg">
                                        <i class="bi bi-music-note me-2"></i>Generate Music
                                    </button>
                                </div>
                            </form>
                        </div>
                        
                        <div class="tab-pane fade" id="parameters-pane" role="tabpanel" aria-labelledby="parameters-tab" tabindex="0">
                            <h2 class="h4 mb-4">Custom Generation Parameters</h2>
                            
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="complexity" class="form-label">Complexity</label>
                                        <select class="form-select" id="complexity" name="complexity">
                                            <option value="simple">Simple</option>
                                            <option value="moderate" selected>Moderate</option>
                                            <option value="complex">Complex</option>
                                            <option value="very_complex">Very Complex</option>
                                        </select>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="mood" class="form-label">Mood</label>
                                        <select class="form-select" id="mood" name="mood">
                                            <option value="happy">Happy</option>
                                            <option value="sad">Sad</option>
                                            <option value="energetic" selected>Energetic</option>
                                            <option value="calm">Calm</option>
                                            <option value="dramatic">Dramatic</option>
                                            <option value="mysterious">Mysterious</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="instruments" class="form-label">Featured Instruments</label>
                                        <select class="form-select" id="instruments" name="instruments" multiple>
                                            <option value="piano">Piano</option>
                                            <option value="guitar">Guitar</option>
                                            <option value="strings">Strings</option>
                                            <option value="drums">Drums</option>
                                            <option value="synth" selected>Synthesizer</option>
                                            <option value="bass">Bass</option>
                                            <option value="brass">Brass</option>
                                        </select>
                                        <div class="small text-muted mt-1">Hold Ctrl/Cmd to select multiple</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="structure" class="form-label">Structure</label>
                                        <select class="form-select" id="structure" name="structure">
                                            <option value="intro_verse_chorus">Intro-Verse-Chorus</option>
                                            <option value="verse_chorus" selected>Verse-Chorus</option>
                                            <option value="ambient">Ambient Flow</option>
                                            <option value="loop">Seamless Loop</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="tab-pane fade" id="advanced-pane" role="tabpanel" aria-labelledby="advanced-tab" tabindex="0">
                            <h2 class="h4 mb-4">Advanced Options</h2>
                            
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="key" class="form-label">Musical Key</label>
                                        <select class="form-select" id="key" name="key">
                                            <option value="C">C Major</option>
                                            <option value="Cm">C Minor</option>
                                            <option value="D">D Major</option>
                                            <option value="Dm">D Minor</option>
                                            <option value="E">E Major</option>
                                            <option value="Em">E Minor</option>
                                            <option value="F">F Major</option>
                                            <option value="Fm">F Minor</option>
                                            <option value="G">G Major</option>
                                            <option value="Gm">G Minor</option>
                                            <option value="A">A Major</option>
                                            <option value="Am" selected>A Minor</option>
                                            <option value="B">B Major</option>
                                            <option value="Bm">B Minor</option>
                                        </select>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="time_signature" class="form-label">Time Signature</label>
                                        <select class="form-select" id="time_signature" name="time_signature">
                                            <option value="4/4" selected>4/4</option>
                                            <option value="3/4">3/4</option>
                                            <option value="6/8">6/8</option>
                                            <option value="5/4">5/4</option>
                                            <option value="7/8">7/8</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="prompt" class="form-label">Text Prompt (Optional)</label>
                                        <textarea class="form-control" id="prompt" name="prompt" rows="3" placeholder="Describe the music you want to generate..."></textarea>
                                        <div class="small text-muted mt-1">Use descriptive language to guide the generation</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="reference_url" class="form-label">Reference Track URL (Optional)</label>
                                        <input type="url" class="form-control" id="reference_url" name="reference_url" placeholder="https://example.com/music.mp3">
                                        <div class="small text-muted mt-1">URL to a reference track for style inspiration</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label d-block">Advanced Voice Settings</label>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" role="switch" id="advancedVocals" name="advancedVocals">
                                    <label class="form-check-label" for="advancedVocals">Enable advanced vocal processing</label>
                                </div>
                            </div>
                            
                            <div id="vocalSettings" class="mb-4 ps-4 border-start" style="display: none;">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="voice_type" class="form-label">Voice Type</label>
                                            <select class="form-select" id="voice_type" name="voice_type">
                                                <option value="female" selected>Female</option>
                                                <option value="male">Male</option>
                                                <option value="neutral">Gender Neutral</option>
                                                <option value="robotic">Robotic</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="lyrics_language" class="form-label">Lyrics Language</label>
                                            <select class="form-select" id="lyrics_language" name="lyrics_language">
                                                <option value="english" selected>English</option>
                                                <option value="spanish">Spanish</option>
                                                <option value="french">French</option>
                                                <option value="japanese">Japanese</option>
                                                <option value="korean">Korean</option>
                                                <option value="none">No Lyrics (Vocalizing)</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="lyrics_theme" class="form-label">Lyrics Theme</label>
                                    <input type="text" class="form-control" id="lyrics_theme" name="lyrics_theme" placeholder="Enter a theme for generated lyrics">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Loading Section (Initially Hidden) -->
                <div class="primary-card mt-4" id="loadingSection" style="display: none;">
                    <div class="card-body">
                        <div class="loading-container">
                            <div class="loading-spinner mb-3"></div>
                            <h3 class="h5 mb-2">Generating Your Music</h3>
                            <p class="text-muted">We're analyzing your video and creating a unique music composition...</p>
                        </div>
                    </div>
                </div>
                
                <!-- 最终播放结果 -->
                <!-- Results Section (Initially Hidden) -->
                <div class="primary-card mt-4" id="resultsSection" style="display: none;">
                    <div class="card-header">
                        <h2 class="h4 mb-0">Your Generated Music</h2>
                    </div>

                    <div class="card-body">
                        <!-- Generation Info Summary -->
                        <div class="result-card mb-4">
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="generation-info">
                                        <div class="mb-2">
                                            <strong>Genre:</strong> <span id="resultGenre">-</span>
                                        </div>
                                        <div class="mb-2">
                                            <strong>Tempo:</strong> <span id="resultTempo">-</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="generation-info">
                                        <div class="mb-2">
                                            <strong>Length:</strong> <span id="resultLength">-</span>
                                        </div>
                                        <div class="mb-2">
                                            <strong>Model:</strong> <span id="resultVocals">-</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 text-md-end">
                                    <div class="generation-info">
                                        <div>Generated at: <span id="generationTime">-</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="audio-player-container">
                            <!-- 主体 -->
                            <div class="d-flex align-items-center mb-3">
                                <button class="btn btn-primary rounded-circle me-3" id="playBtn" style="width: 50px; height: 50px;">
                                    <i class="bi bi-play-fill"></i>
                                </button>

                                <div class="flex-grow-1">
                                    <audio id="musicPlayer" class="audio-player" preload="metadata"></audio>
                                    <div id="waveform" class="waveform-container"></div>
                                </div>
                            </div>
                            
                            <!-- Video result (if available) -->
                            <div class="video-result-container mt-4 mb-4">
                                <h3 class="h5 mb-3">Video with Generated Music</h3>
                                <div class="video-container">
                                    <video id="resultVideo" class="w-100" controls preload="auto">
                                        <source src="" type="video/mp4">
                                        Your browser does not support the video tag.
                                    </video>
                                </div>
                                <div class="small text-muted mt-2">If audio doesn't play automatically, click the video to play with sound</div>
                            </div>
                            
                            <!-- 按钮 -->
                            <div class="d-flex justify-content-end">
                                <button class="btn btn-outline-primary me-2" id="regenerateBtn">
                                    <i class="bi bi-arrow-repeat me-2"></i>Regenerate
                                </button>
                                <!--- <a  download class="btn btn-primary" id="downloadBBtn">
                                   <i class="bi bi-download me-2"></i>Download
                                </a> --->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <footer class="py-4 mt-5 border-top" style="background: rgba(0, 0, 0, 0.3);">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h3 class="h5 logo-text mb-3">AI Music Generator</h3>
                    <p class="text-muted mb-0">Create unique music compositions powered by advanced AI technology</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <ul class="list-inline mb-0">
                        <li class="list-inline-item"><a href="#" class="text-decoration-none text-white-50">About</a></li>
                        <li class="list-inline-item"><a href="#" class="text-decoration-none text-white-50">Privacy</a></li>
                        <li class="list-inline-item"><a href="#" class="text-decoration-none text-white-50">Terms</a></li>
                        <li class="list-inline-item"><a href="#" class="text-decoration-none text-white-50">Contact</a></li>
                    </ul>
                    <!-- <p class="text-muted mt-2 mb-0">&copy; 2023 AI Music Generator. All rights reserved.</p> -->
                </div>
            </div>
        </div>
    </footer>

    
    <script>
        // 添加视频错误监听器
        document.addEventListener('DOMContentLoaded', function() {
            const resultVideo = document.getElementById('resultVideo');
            if (resultVideo) {
                resultVideo.addEventListener('error', function(e) {
                    console.error('Video error event:', e);
                    const videoError = resultVideo.error;
                    if (videoError) {
                        console.error('Video error code:', videoError.code);
                        console.error('Video error message:', videoError.message);
                    }
                    showAlert('视频播放出错，请检查控制台获取详细信息', 'warning');
                });
            }
        });
        
        function showAlert(message, type = 'info') {
            const alertBox = document.createElement('div');
            alertBox.className = `alert alert-${type}`;
            alertBox.textContent = message;
            document.getElementById('alertsContainer')?.appendChild(alertBox);
            setTimeout(() => alertBox.remove(), 5000);
        }

        function updateMusicInfo(data) {
            if (!data || !data.generation_info) return;
            const info = data.generation_info;

            // 1. 更新界面上的信息
            if (document.getElementById('resultGenre')) {
                document.getElementById('resultGenre').textContent = info.genre || '-';
                document.getElementById('resultTempo').textContent = info.complexity === 'complex' ? '140 BPM' : '120 BPM';
                document.getElementById('resultLength').textContent = '30 seconds';
                document.getElementById('resultVocals').textContent = info.model || '-';
                document.getElementById('generationTime').textContent = info.generated_at || '-';
            }

            // 2. 决定使用哪个播放器
            let useAudioPlayer = true;
            let urlToUse = data.music_url;
            
            // 如果有视频URL，优先使用视频播放器
            if (info.video_url) {
                useAudioPlayer = false;
                urlToUse = info.video_url;
            }                // 3. 更新视频播放器
            const videoElement = document.getElementById('resultVideo');
            const videoContainer = document.querySelector('.video-result-container');
            
            if (info.video_url && videoElement) {
                console.log('更新视频播放器, URL:', info.video_url);
                
                // 确保视频元素是可见的
                if (videoContainer) {
                    videoContainer.style.display = 'block';
                }
                
                // 清空现有源
                while (videoElement.firstChild) {
                    videoElement.removeChild(videoElement.firstChild);
                }
                
                // 创建新源
                const source = document.createElement('source');
                // 使用已经包含时间戳的URL，不要再添加时间戳
                source.src = info.video_url;
                source.type = 'video/mp4';
                videoElement.appendChild(source);
                
                // 确保音量是打开的
                videoElement.muted = false;
                videoElement.volume = 1.0;
                
                // 重新加载视频
                videoElement.load();
                
                // 添加调试信息
                console.log('Video player settings:');
                console.log('- muted:', videoElement.muted);
                console.log('- volume:', videoElement.volume);
                console.log('- controls:', videoElement.controls);
                console.log('- autoplay:', videoElement.autoplay);
                
                // 视频加载完成后进行额外检查
                videoElement.onloadeddata = function() {
                    console.log('视频加载完成，准备播放');
                    console.log('- Has audio tracks:', videoElement.audioTracks ? videoElement.audioTracks.length : 'Not supported');
                    console.log('- Current time:', videoElement.currentTime);
                    console.log('- Duration:', videoElement.duration);
                    
                    // 确保再次设置音量和静音状态
                    videoElement.muted = false;
                    videoElement.volume = 1.0;
                    
                    try {
                        // 尝试自动播放，但可能被浏览器阻止
                        videoElement.play()
                            .then(() => console.log('视频开始播放'))
                            .catch(e => {
                                console.error('视频自动播放失败:', e);
                                console.log('用户需要手动点击播放按钮');
                            });
                    } catch (err) {
                        console.error('播放视频时出错:', err);
                    }
                };
            } else if (videoContainer) {
                videoContainer.style.display = 'none';
            }
            
            // 4. 更新音频播放器（当没有视频时使用）
            const audioPlayer = document.getElementById('musicPlayer');
            if (audioPlayer) {
                if (useAudioPlayer && data.music_url) {
                    console.log('更新音频播放器, URL:', data.music_url);
                    audioPlayer.src = data.music_url + "?t=" + new Date().getTime();
                    audioPlayer.load();
                    
                    // 音频加载完成后显示波形
                    audioPlayer.onloadeddata = function() {
                        if (window.wavesurfer) {
                            window.wavesurfer.load(audioPlayer.src);
                        }
                    };
                } else {
                    // 如果使用视频播放器，则禁用音频播放器
                    audioPlayer.src = '';
                }
            }

            // 显示结果部分
            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
        }

        // 拖拽上传功能
        function setupVideoUpload() {
            const uploadZone = document.getElementById('videoUploadZone');
            const fileInput = document.getElementById('videoFile');
            const videoPreviewContainer = document.getElementById('videoPreviewContainer');
            const videoPreview = document.getElementById('videoPreview');
            const uploadProgress = document.getElementById('uploadProgress');
            const videoFileNameEl = document.getElementById('videoFileName');
            const removeVideoBtn = document.getElementById('removeVideoBtn');

            if (!uploadZone || !fileInput) return;

            uploadZone.addEventListener('click', () => fileInput.click());

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadZone.addEventListener(eventName, e => {
                    e.preventDefault();
                    e.stopPropagation();
                });
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                uploadZone.addEventListener(eventName, () => uploadZone.classList.add('drag-over'));
            });

            ['dragleave', 'drop'].forEach(eventName => {
                uploadZone.addEventListener(eventName, () => uploadZone.classList.remove('drag-over'));
            });

            uploadZone.addEventListener('drop', (e) => {
                const files = e.dataTransfer.files;
                if (files.length) {
                    fileInput.files = files;
                    handleVideoFile(files[0]);
                }
            });

            fileInput.addEventListener('change', () => {
                if (fileInput.files.length) {
                    handleVideoFile(fileInput.files[0]);
                }
            });

            function handleVideoFile(file) {
                if (!file.type.match('video/*')) {
                    showAlert('请选择有效的视频文件', 'danger');
                    return;
                }

                if (videoFileNameEl) videoFileNameEl.textContent = file.name;

                const reader = new FileReader();
                reader.onload = function(e) {
                    videoPreview.src = e.target.result;
                    videoPreviewContainer.style.display = 'block';
                    removeVideoBtn.style.display = 'block';
                    uploadZone.style.display = 'none'; // 隐藏上传区
                };
                reader.readAsDataURL(file);
            }
        }

        setupVideoUpload();

        // 音乐风格选择
        document.querySelectorAll('.genre-card').forEach(card => {
            card.addEventListener('click', function() {
                // 移除其他卡片的选中状态
                document.querySelectorAll('.genre-card').forEach(c => {
                    c.classList.remove('selected');
                });
                
                // 添加选中状态到当前卡片
                this.classList.add('selected');
                
                // 更新隐藏输入值
                const genre = this.getAttribute('data-genre');
                document.getElementById('selectedGenre').value = genre;
                console.log(`已选择音乐风格: ${genre}`);
            });
        });

        // 模型按钮点击逻辑
        document.getElementById('gptModelBtn')?.addEventListener('click', function () {
            document.getElementById('modelTypeInput').value = 'gpt';
            this.classList.remove('btn-outline-primary');
            this.classList.add('btn-primary');
            document.getElementById('localModelBtn').classList.remove('btn-primary');
            document.getElementById('localModelBtn').classList.add('btn-outline-primary');
        });

        document.getElementById('localModelBtn')?.addEventListener('click', function () {
            document.getElementById('modelTypeInput').value = 'local';
            this.classList.remove('btn-outline-primary');
            this.classList.add('btn-primary');
            document.getElementById('gptModelBtn').classList.remove('btn-primary');
            document.getElementById('gptModelBtn').classList.add('btn-outline-primary');
        });


        document.getElementById('generationForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const form = this;
            const modelType = document.getElementById('modelTypeInput').value;
            const videoFile = document.getElementById('videoFile').files[0];
            const loadingSection = document.getElementById('loadingSection');
            const resultsSection = document.getElementById('resultsSection');

            if (!modelType) {
                showAlert('请先选择一个AI模型', 'warning');
                return;
            }
            if (!videoFile) {
                showAlert('请上传一个视频文件', 'warning');
                return;
            }

            if (loadingSection) {
                loadingSection.style.display = 'block';
                loadingSection.scrollIntoView({ behavior: 'smooth' });
            }
            if (resultsSection) resultsSection.style.display = 'none';

            const formData = new FormData(form);

            const isGptSelected = document.getElementById('gptModelBtn').classList.contains('btn-primary');
            const isLocalSelected = document.getElementById('localModelBtn').classList.contains('btn-primary');

            let targetUrl = '';
            if (isGptSelected) {
                targetUrl = 'gpt-generate-music/';
            } else if (isLocalSelected) {
                targetUrl = 'local-model-generate-music/';
            } else {
                showAlert('请先选择一个AI模型', 'warning');
                return;
            }

            fetch(targetUrl, {
                method: 'POST',
                headers: { 'X-Requested-With': 'XMLHttpRequest' },
                body: formData
            })
            .then(response => {
                if (!response.ok) throw new Error('服务器错误');
                return response.json();
            })
            .then(data => {
                loadingSection.style.display = 'none';
                if (data.music_url) {
                    resultsSection.style.display = 'block';
                    resultsSection.scrollIntoView({ behavior: 'smooth' });
                    
                    // 添加时间戳防止缓存，确保URL格式正确
                    if (data.music_url) {
                        // 完全移除所有查询参数并添加新的时间戳
                        const baseUrl = data.music_url.split('?')[0];
                        data.music_url = baseUrl + "?t=" + new Date().getTime();
                    }
                    if (data.generation_info && data.generation_info.video_url) {
                        // 完全移除所有查询参数并添加新的时间戳
                        const baseUrl = data.generation_info.video_url.split('?')[0];
                        data.generation_info.video_url = baseUrl + "?t=" + new Date().getTime();
                    }
                    
                    console.log('收到数据:', data);
                    console.log('音乐URL:', data.music_url);
                    if (data.generation_info && data.generation_info.video_url) {
                        console.log('视频URL:', data.generation_info.video_url);
                    }
                    
                    // 更新结果信息和媒体播放器
                    updateMusicInfo(data);
                    
                    // 确认视频已加载
                    const videoElement = document.getElementById('resultVideo');
                    if (videoElement && data.generation_info.video_url) {
                        console.log('检查视频是否已加载');
                        setTimeout(() => {
                            if (videoElement.readyState === 0) {
                                console.log('视频未加载，尝试重新加载');
                                videoElement.load();
                            }
                        }, 1000);
                    }
                    
                } else {
                    showAlert('生成失败：' + (data.error || '未返回音乐链接'), 'danger');
                }
            })
            .catch(err => {
                loadingSection.style.display = 'none';
                showAlert('音乐生成失败，请稍后重试', 'danger');
                console.error(err);
            });
        });

        document.getElementById('regenerateBtn')?.addEventListener('click', function () {
            document.getElementById('generationForm').dispatchEvent(new Event('submit'));
        });

        // 播放按钮逻辑
        document.getElementById('playBtn')?.addEventListener('click', function () {
            const audioPlayer = document.getElementById('musicPlayer');
            const videoPlayer = document.getElementById('resultVideo');
            const videoHasSource = videoPlayer && videoPlayer.querySelector('source') && videoPlayer.querySelector('source').src;
            
            // 判断是播放视频还是音频
            if (videoHasSource) {
                // 如果有视频源，控制视频播放
                console.log('使用视频播放器');
                
                // 确保视频没有静音
                videoPlayer.muted = false;
                videoPlayer.volume = 1.0;
                
                if (videoPlayer.paused) {
                    // 打印一些调试信息
                    console.log('视频播放前状态:');
                    console.log('- muted:', videoPlayer.muted);
                    console.log('- volume:', videoPlayer.volume);
                    console.log('- currentSrc:', videoPlayer.currentSrc);
                    
                    videoPlayer.play()
                        .then(() => {
                            this.innerHTML = '<i class="bi bi-pause-fill"></i>';
                            console.log('视频开始播放');
                            
                            // 再次确认音频状态
                            setTimeout(() => {
                                console.log('播放5秒后状态:');
                                console.log('- muted:', videoPlayer.muted);
                                console.log('- volume:', videoPlayer.volume);
                                console.log('- paused:', videoPlayer.paused);
                                console.log('- currentTime:', videoPlayer.currentTime);
                            }, 5000);
                        })
                        .catch(err => {
                            console.error('播放视频出错:', err);
                            showAlert('视频播放失败，请直接点击视频播放', 'warning');
                        });
                } else {
                    videoPlayer.pause();
                    this.innerHTML = '<i class="bi bi-play-fill"></i>';
                }
            } else if (audioPlayer.src) {
                // 如果没有视频，使用音频播放器
                console.log('使用音频播放器');
                if (audioPlayer.paused) {
                    audioPlayer.play();
                    this.innerHTML = '<i class="bi bi-pause-fill"></i>'; // 改变按钮图标为暂停
                } else {
                    audioPlayer.pause();
                    this.innerHTML = '<i class="bi bi-play-fill"></i>'; // 改变按钮图标为播放
                }
            } else {
                showAlert('没有可播放的音频或视频', 'warning');
            }
        });
    </script>
</body>
</html> 